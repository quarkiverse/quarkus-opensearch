= Quarkus Opensearch Extension

include::./includes/attributes.adoc[]

The quarkus-opensearch extension allows you to connect to an link:https://opensearch.org/[OpenSearch cluster] using the clients provided by the OpenSearch project.

== OpenSearch Clients

OpenSearch provides three different flavours of clients for connecting to the cluster. This extension has support for all three of them.

=== link:https://opensearch.org/docs/latest/clients/java/[OpenSearch Java Client]

This is the latest implementation of the OpenSearch clients, when starting a new project you should use this client and not bother about the others.
This will be the only OpenSearch Client supported in the future.
Just like the OpenSearch REST high-level level, the OpenSearch Java client lets you interact with OpenSearch through Java methods and data structures. In comparison to the REST high-level, it has no dependency to `org.opensearch:opensearch` and also provides an async client implementation.

[NOTE]
.Deprecation
====
The OpenSearch REST clients are deprecated. Support will be removed in OpenSearch version 3.0.0.

It is recommended to switch to the Java client.
We will try to support the REST clients as long as possible, but if you start a new project this is not the client you should use anymore.
====

=== link:https://opensearch.org/docs/latest/clients/java-rest-high-level/[OpenSearch REST High-Level Client]

The OpenSearch Java high-level REST client lets you interact with your OpenSearch clusters and indices through Java methods and data structures rather than HTTP methods and JSON.

=== OpenSearch REST (low-level) client

Core low-level client which lets you interact with OpenSearch clusters through HTTP methods and JSON, it is also used by the two other higher level clients for connecting to the cluster.

== Installation

=== OpenSearch Java client

The java client does not have any dependencies on the REST client. All clients are sharing most of the configuration properties.
The AWS related configuration properties `quarkus.opensearch.aws.*` are only applicable to this java client.

If you want to use this client all you need to do is add the `io.quarkiverse.opensearch:quarkus-opensearch-java-client` extension first to your build file.

with Maven, add the following dependency to your POM file:

[source,xml,subs=attributes+]
----
<dependency>
    <groupId>io.quarkiverse.opensearch</groupId>
    <artifactId>quarkus-opensearch-java-client</artifactId>
    <version>{project-version}</version>
</dependency>
----

=== Transport Provider (Required)

The Java client requires a transport provider to communicate with OpenSearch. You **must** add one of the following transport dependencies based on your deployment target.

==== Apache HttpClient5 Transport (Recommended)

Use this transport for:

* Local development with Dev Services
* Self-hosted OpenSearch clusters
* Any non-AWS deployment

[source,xml]
----
<dependency>
  <groupId>io.quarkiverse.opensearch</groupId>
  <artifactId>quarkus-opensearch-transport-apache</artifactId>
</dependency>
----

==== AWS SDK2 Transport

Use this transport **only** when connecting to AWS OpenSearch Service or AWS OpenSearch Serverless. This transport requires the `quarkus.opensearch.aws.service` configuration property to be set.

[source,xml]
----
<dependency>
  <groupId>io.quarkiverse.opensearch</groupId>
  <artifactId>quarkus-opensearch-transport-aws</artifactId>
</dependency>
----

[source,properties]
----
# Required for AWS transport to activate
quarkus.opensearch.aws.service=es    # or 'aoss' for OpenSearch Serverless
quarkus.opensearch.aws.region=us-west-2
----

==== Using Both Transports

If you deploy to AWS but also use Dev Services for local development, you can include both transport dependencies. The appropriate transport will be selected automatically based on your configuration:

* When `quarkus.opensearch.aws.service` is set → AWS transport is used
* When `quarkus.opensearch.aws.service` is not set → Apache transport is used

[source,xml]
----
<!-- For local development and Dev Services -->
<dependency>
  <groupId>io.quarkiverse.opensearch</groupId>
  <artifactId>quarkus-opensearch-transport-apache</artifactId>
</dependency>

<!-- For AWS deployment -->
<dependency>
  <groupId>io.quarkiverse.opensearch</groupId>
  <artifactId>quarkus-opensearch-transport-aws</artifactId>
</dependency>
----

[source,properties]
----
# Only set AWS config in production profile
%prod.quarkus.opensearch.aws.service=es
%prod.quarkus.opensearch.aws.region=us-west-2
%prod.quarkus.opensearch.hosts=search-mydomain.us-west-2.es.amazonaws.com
----

[IMPORTANT]
====
If no matching transport provider is found, the application will fail at runtime with a detailed error message explaining which providers are available and what configuration is needed.
====

==== Configuring Additional Named Clients

This extension supports defining and injecting multiple named OpenSearch clients,
useful when your application needs to connect to different OpenSearch clusters
(e.g., for analytics, logging, or operational data).

A named client can be configured using `quarkus.opensearch."client-name".*`.

===== Example: Default and Additional Client

[source,properties]
----
# Default client (unnamed)
quarkus.opensearch.hosts=localhost:9200

# Additional client named "analytics"
quarkus.opensearch.analytics.hosts=analytics-cluster.internal:9200
quarkus.opensearch.analytics.username=some-user
quarkus.opensearch.analytics.password=some-password
quarkus.opensearch.analytics.aws.region=us-west-2
----

===== Injecting the Default Client

If you're using only a single OpenSearch cluster, you can inject the default client without any qualifiers:

[source,java]
----
import jakarta.inject.Inject;
import org.opensearch.client.opensearch.OpenSearchClient;

public class MyService {

    @Inject
    OpenSearchClient defaultClient;

    public void run() {
        // Use the defaultClient to interact with OpenSearch
    }
}
----


===== Injecting Named Clients in Your Code

To use a named client in your application, inject it using the `@OpenSearchClientName` qualifier:

[source,java]
----
import jakarta.inject.Inject;
import io.quarkiverse.opensearch.OpenSearchClientName;
import org.opensearch.client.opensearch.OpenSearchClient;

public class ReportService {

    @Inject
    @OpenSearchClientName("analytics")
    OpenSearchClient analyticsClient;

    public void runQuery() {
        // Use the analyticsClient to run a search
    }
}
----

[NOTE]
====
The `@OpenSearchClientName("<client-name>")` injection is only supported for the OpenSearch Java Client module.
====

=== OpenSearch REST High-Level Client

The REST High-Level Client depends on the REST client and does not require any additional configuration.

If you want to use this client all you need to do is add the `io.quarkiverse.opensearch:quarkus-opensearch-rest-high-level-client` extension first to your build file.

with Maven, add the following dependency to your POM file:

[source,xml,subs=attributes+]
----
<dependency>
    <groupId>io.quarkiverse.opensearch</groupId>
    <artifactId>quarkus-opensearch-rest-high-level-client</artifactId>
    <version>{project-version}</version>
</dependency>
----

=== OpenSearch REST Low-Level Client

If you want to use this extension, you need to add the `io.quarkiverse.opensearch:quarkus-opensearch-rest-client` extension first to your build file.

For instance, with Maven, add the following dependency to your POM file:

[source,xml,subs=attributes+]
----
<dependency>
    <groupId>io.quarkiverse.opensearch</groupId>
    <artifactId>quarkus-opensearch-rest-client</artifactId>
    <version>{project-version}</version>
</dependency>
----

== Configuring Opensearch
The main property to configure is the URL to connect to the Opensearch cluster.

For a typical clustered Opensearch service, a sample configuration would look like the following:

[source,properties]
----
# configure the Elasticsearch client for a cluster of two nodes
quarkus.opensearch.hosts = opensearch-01:9200,opensearch-02:9200
----

In this case, we are using a single instance running on localhost:

[source,properties]
----
# configure the Opensearch client for a single instance on localhost
quarkus.opensearch.hosts = localhost:9200
----

If you need a more advanced configuration, you can find the comprehensive list of supported configuration properties at the end of this guide.

=== SSL/TLS Configuration

When connecting to OpenSearch over HTTPS, you can configure TLS settings using the Quarkus TLS registry. This is the recommended approach for managing SSL/TLS configuration.

==== Basic HTTPS Connection

For HTTPS connections with valid certificates trusted by the JVM:

[source,properties]
----
quarkus.opensearch.hosts=opensearch.example.com:9200
quarkus.opensearch.protocol=https
quarkus.opensearch.username=admin
quarkus.opensearch.password=admin
----

==== Using a Custom Trust Store

To use a custom trust store (e.g., for self-signed certificates):

[source,properties]
----
quarkus.opensearch.hosts=opensearch.example.com:9200
quarkus.opensearch.protocol=https
quarkus.opensearch.tls.tls-configuration-name=opensearch-tls

# Define the TLS configuration
quarkus.tls.opensearch-tls.trust-store.p12.path=/path/to/truststore.p12
quarkus.tls.opensearch-tls.trust-store.p12.password=changeit
----

==== Disabling SSL Verification (Development Only)

[WARNING]
====
Disabling SSL verification should **only** be used in development environments. Never disable SSL verification in production.
====

For development environments where you don't have valid certificates:

[source,properties]
----
quarkus.opensearch.hosts=opensearch.example.com:9200
quarkus.opensearch.protocol=https
quarkus.opensearch.tls.tls-configuration-name=opensearch-dev

# Trust all certificates and disable hostname verification
quarkus.tls.opensearch-dev.trust-all=true
quarkus.tls.opensearch-dev.hostname-verification-algorithm=NONE
----

You can scope this to development mode only using profiles:

[source,properties]
----
# Production uses proper certificates
%prod.quarkus.opensearch.protocol=https

# Development trusts all certificates
%dev.quarkus.opensearch.tls.tls-configuration-name=dev-tls
%dev.quarkus.tls.dev-tls.trust-all=true
%dev.quarkus.tls.dev-tls.hostname-verification-algorithm=NONE
----

[NOTE]
====
The legacy `quarkus.opensearch.ssl.*` properties are deprecated and will be removed in a future version. Please migrate to the Quarkus TLS registry configuration shown above.
====

[[dev-services]]
=== Dev Services

Quarkus supports a feature called Dev Services that allows you to start various containers without any config.
In the case of Opensearch, this support extends to the default Opensearch connection.
What that means practically is that, if you have not configured `quarkus.opensearch.hosts`, Quarkus will automatically
start an Opensearch container when running tests or dev mode, and automatically configure the connection.

When running the production version of the application, the Opensearch connection needs to be configured as usual,
so if you want to include a production database config in your `application.properties` and continue to use Dev Services
we recommend that you use the `%prod.` profile to define your Opensearch settings.

[[extension-configuration-reference]]
== Extension Configuration Reference

include::includes/quarkus-opensearch-client.adoc[leveloffset=+1, opts=optional]